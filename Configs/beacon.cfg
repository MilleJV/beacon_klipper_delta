# --------------------------------------------------------------------
# --- Beacon Configuration File
# --- Config by Javier Miller
# --------------------------------------------------------------------
# This file contains all settings for the Beacon probe.
#
# --- IMPORTANT: PRINTER.CFG REQUIREMENTS ---
# 
# This file must be loaded by adding the following line to your
# main 'printer.cfg' file:
# [include beacon.cfg]
#
# The settings below are intrinsically linked to other sections in
# your 'printer.cfg'. Please ensure they are set correctly.
#
# --- [printer] ---
# kinematics: This config is designed to be kinematics-neutral,
#     but your 'printer.cfg' must have this defined.
#
# --- [bed_mesh] ---
# The [bed_mesh] section MUST be in your 'printer.cfg' and configured
# for your bed type. Beacon's scan logic depends on it.
#
#   Example for DELTA / ROUND beds:
#   [bed_mesh]
#   mesh_radius: 110
#   mesh_origin: 0,0
#   round_probe_count: 31
#   algorithm: bicubic
#   bicubic_tension: 0.5
#
#   Example for CARTESIAN/COREXY / SQUARE beds:
#   [bed_mesh]
#   mesh_min: 10, 10
#   mesh_max: 290, 290
#   probe_count: 7, 7
#   algorithm: bicubic
#   bicubic_tension: 0.5
#
# --- [resonance_tester] ---
# To use the Beacon's accelerometer, you must set:
#   [resonance_tester]
#   accel_chip: beacon
#   probe_points: X, Y, Z  # (e.g., 0, 0, 20 for a delta)
#
# --- Conflicting Sections ---
# You MUST remove or comment out any existing [probe] section
# from your 'printer.cfg' to prevent conflicts.
#
# --- G-CODE COMMANDS ---
# This module adds many new G-Code commands.
# See the "G-Code Command Reference" at the END of this file.
#
# --------------------------------------------------------------------

[beacon]
# --------------------------------------------------------------------
# --- USER CALIBRATION REQUIRED ---
# --- These settings are unique to your printer and MUST be set!
# --------------------------------------------------------------------
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_C3703B8F5157383837202020FF052B09-if00
#   CRITICAL: This is your Beacon's unique USB ID.
#   Find yours by running 'ls /dev/serial/by-id/' in your Pi's console.

x_offset: 0
#   MUST-CALIBRATE: X-offset of the probe (sensor) relative to the nozzle.
#   Run PROBE_CALIBRATE to find this.

y_offset: -6.75
#   MUST-CALIBRATE: Y-offset of the probe (sensor) relative to the nozzle.
#   Run PROBE_CALIBRATE to find this.

backlash_comp: 0.01803
#   MUST-TUNE: The distance (in mm) to move *past* the target Z-height
#   and then return, to ensure Z-axis backlash is removed.
#   Run BEACON_ESTIMATE_BACKLASH to find this value.

# --- For DELTA printers ---
home_xy_position: 0,0
#   MUST-SET: The X,Y coordinate where Z-homing will be performed.
#   For deltas, this MUST be 0,0.

# --- For CARTESIAN/COREXY printers ---
#home_xy_position: 150,150
#   MUST-SET: The X,Y coordinate where Z-homing will be performed.
#   This should be the CENTER of your bed.

accel_axes_map: x, y, z
#   MUST-VERIFY: Reassigns or inverts the accelerometer axes.
#   If your resonance graphs look wrong (e.g., X graph shows Y
#   movement), you may need to change this (e.g., 'y, x, z').
#   (Default: x, y, z)

# --------------------------------------------------------------------
# --- General Beacon Settings (Good Defaults)
# --------------------------------------------------------------------
default_model_name: default
#   The name of the calibration model to load when Klipper starts.

default_probe_method: proximity
#   Sets the default probing method (proximity or contact).
#   - "proximity": (Default) Fast, non-contact probing. Requires a model.
#   - "contact": Slower, accelerometer-based nozzle-touch probing.

# --------------------------------------------------------------------
# --- Proximity Probing & Homing Settings (Good Defaults)
# --------------------------------------------------------------------
trigger_distance: 2.0
#   The target Z-distance (in mm) from the bed that the probe will
#   consider its "trigger" point.
#   (Default: 2.0)

trigger_dive_threshold: 1.0
#   If the probe measures a distance greater than
#   (trigger_distance + trigger_dive_threshold), it will perform a
#   slow "homing dive" instead of a fast sample.
#   (Default: 1.0)

trigger_hysteresis: 0.006
#   A small percentage to prevent signal noise from causing
#   false triggers during homing.
#   (Default: 0.006)

z_settling_time: 5
#   Delay (in milliseconds) to wait for the Z-axis to settle
#   before taking a proximity measurement.
#   (Default: 5)

# --------------------------------------------------------------------
# --- Model Calibration Settings (BEACON_CALIBRATE)
# --------------------------------------------------------------------
cal_nozzle_z: 0.1
#   The height of the 'feeler gauge' or paper used during the
#   manual probing step of calibration.
#   (Default: 0.1)

cal_floor: 0.2
#   The lowest Z-height (relative to the nozzle) that the
#   calibration scan will measure.
#   (Default: 0.2)

cal_ceil: 5.0
#   The highest Z-height (relative to the nozzle) that the
#   calibration scan will measure.
#   (Default: 5.0)

cal_speed: 1.0
#   Speed (in mm/s) of the slow downward move used when
#   measuring the sensor's response curve.
#   (Default: 1.0)

cal_move_speed: 30.0
#   Speed (in mm/s) of the faster moves used to get into
#   position for the calibration scan.
#   (Default: 10.0)

# --------------------------------------------------------------------
# --- Contact Probing & Auto-Calibration Settings
# --------------------------------------------------------------------
contact_max_hotend_temperature: 180
#   A safety limit. Contact probing (G28, AUTO_CALIBRATE, etc.)
#   will fail if the nozzle is hotter than this value.
#   (Default: 180)

contact_sensitivity: 0
#   Adjusts noise tolerance for contact probing (0-3).
#   0 = Most sensitive (triggers on smallest impact)
#   3 = Least sensitive (tolerates the most noise)
#   (Default: 0)

contact_latency_min: 0
#   Minimum latency (in clock ticks) for a contact to be
#   considered valid.
#   (Default: 0)

autocal_speed: 2
#   Speed (in mm/s) for the *contact* probing moves during
#   BEACON_AUTO_CALIBRATE.
#   (Default: 3.0)

autocal_accel: 100
#   Acceleration (in mm/s^2) for the auto-calibration moves.
#   (Default: 100)

autocal_retract_dist: 2
#   The Z-distance (in mm) to lift the nozzle between
#   each contact probe during auto-calibration.
#   (Default: 2)

autocal_retract_speed: 10
#   The speed (in mm/s) of the retraction move.
#   (Default: 10)

autocal_sample_count: 20
#   The number of contact probe samples to take.
#   (Default: 3)

autocal_tolerance: 0.008
#   If the range (max - min) of collected samples exceeds this
#   value (in mm), it will retry.
#   (Default: 0.008)

autocal_max_retries: 3
#   Number of times to retry the full sample set if the
#   tolerance is exceeded.
#   (Default: 3)

# --------------------------------------------------------------------
# --- Mesh Scanning Settings (BED_MESH_CALIBRATE)
# --------------------------------------------------------------------
mesh_main_direction: x
#   The primary travel direction for the "fast" part of the
#   serpentine scan. X or Y.
#   (Default: Y)

mesh_overscan: 10
#   The distance (in mm) to travel *past* the mesh boundary
#   when making the U-turn to the next scan line.
#   (Default: -1, which enables auto-calculation)

mesh_cluster_size: 0
#   The radius (in mm) around a grid point to include samples.
#   WARNING: Must be 0 for "fly-by" scanning. Any other value
#   will discard almost all samples and cause "Empty clusters" errors.
#   (Default: 0)

mesh_runs: 2
#   The number of passes to make over the bed.
#   (Default: 1). Set to 2 or more for excellent noise reduction.

zero_reference_cluster_size: 1.0
#   If using 'zero_reference_position' in [bed_mesh], this is
#   the radius to use for collecting samples at that point.
#   (Default: 1.0)

# --------------------------------------------------------------------
# --- Homing Override Settings (G28) ---
# --------------------------------------------------------------------
home_method: proximity
#   The default method to use for G28 Z-homing.
#   - "proximity": (Requires a calibrated model)
#   - "contact": Uses the nozzle-touch accelerometer method.
#   - "proximity_if_available": Tries proximity, falls back to contact.
#   (Default: proximity)

home_autocalibrate: always
#   Controls if BEACON_AUTO_CALIBRATE is run during G28.
#   - "always": Runs every time (slow, but most precise).
#   - "unhomed": Runs only if the printer is not already homed.
#   - "never": Never runs (fastest, relies on existing model).
#   (Default: always)

# --- Optional Homing G-Code Hooks ---
#home_z_hop: 5
#home_z_hop_speed: 30
#home_xy_move_speed: 300
#home_y_before_x: False
#home_gcode_pre_x:
#home_gcode_post_x:
#home_gcode_pre_y:
#home_gcode_post_y:

# --- Optional Contact G-Code Hooks ---
#contact_activate_gcode:
#contact_deactivate_gcode:

# --------------------------------------------------------------------
# --- Accelerometer Settings (Resonance Testing)
# --------------------------------------------------------------------
accel_scale: 16g
#   Adjusts the sensitivity of the accelerometer.
#   Valid settings: 16g, 8g, 4g, 2g.
#   (Default: 16g)

# --------------------------------------------------------------------
# --- G-Code Command Reference
# --------------------------------------------------------------------
#
# --- Calibration Commands ---
#
# BEACON_CALIBRATE [MODEL_NAME=<name>] [SKIP_MANUAL_PROBE=1]
#                  [NOZZLE_Z=<val>] [FLOOR=<val>] [CEIL=<val>]
#                  [DESCEND_SPEED=<val>] [MOVE_SPEED=<val>]
#   Desc: Runs the full proximity model calibration.
#   Parameters:
#     MODEL_NAME: The name to save the new model as. (Default: 'default')
#     SKIP_MANUAL_PROBE: If 1, skips the paper test. (Default: 0)
#     NOZZLE_Z: Height of your paper/feeler gauge. (Default: 0.1)
#     FLOOR/CEIL: Min/Max Z height for the scan. (Default: 0.2/5.0)
#
# BEACON_AUTO_CALIBRATE [SAMPLES=<n>] [SKIP_MODEL_CREATION=1] ...
#   Desc: Homes Z-axis using nozzle-contact, then runs BEACON_CALIBRATE.
#   Parameters:
#     SAMPLES: Number of contact probes to average. (Default: 3)
#     SAMPLES_TOLERANCE: Accuracy required. (Default: 0.008)
#     SKIP_MODEL_CREATION: If 1, only homes and sets Z=0. (Default: 0)
#     (See [beacon] autocal_... settings for more parameters)
#
# --- Probing Commands ---
#
# PROBE [PROBE_METHOD=<proximity|contact>] [PROBE_SPEED=<val>]
#   Desc: Performs a single Z-probe at the current XY position.
#   Parameters:
#     PROBE_METHOD: 'proximity' or 'contact'.
#                   (Default: [beacon] default_probe_method)
#     PROBE_SPEED: Speed of the probe move.
#
# PROBE_ACCURACY [SAMPLES=<n>] [PROBE_SPEED=<val>] [SAMPLE_RETRACT_DIST=<val>]
#   Desc: Probes multiple times at the same point and reports statistics.
#   Parameters:
#     SAMPLES: Number of probes to perform. (Default: 10)
#     SAMPLE_RETRACT_DIST: Z distance to lift between probes. (Default: 0)
#
# BEACON_POKE [TOP=<val>] [BOTTOM=<val>] [SPEED=<val>]
#   Desc: Performs a single contact-probe test and logs data to /tmp/.
#   Parameters:
#     TOP/BOTTOM: Z-range for the poke move. (Default: 5.0 / -0.3)
#     SPEED: Speed of the poke. (Default: 3.0)
#
# BEACON_OFFSET_COMPARE [TOP=<val>] [SAMPLES=<n>] ...
#   Desc: Probes with *both* contact and proximity methods to measure
#         the difference between them.
#   Parameters:
#     TOP: The Z-height to move to for the proximity sample. (Default: 2.0)
#
# BEACON_ESTIMATE_BACKLASH [SAMPLES=<n>] [Z=<val>] [OVERRUN=<val>]
#   Desc: Probes from above and below a Z height to measure backlash.
#   Parameters:
#     SAMPLES: Total number of probes to perform. (Default: 20)
#     Z: The target Z-height to test. (Default: [beacon] trigger_distance)
#     OVERRUN: Distance to move past the target. (Default: 1.0)
#
# Z_OFFSET_APPLY_PROBE
#   Desc: Applies the current Z-Offset (from babystepping)
#         permanently to the Beacon's model_offset.
#
# --- Overridden Klipper Commands ---
#
# G28 [X] [Y] [Z] [METHOD=<...>] [CALIBRATE=<0|1>]
#   Desc: Overrides G28 to use Beacon for Z-homing.
#   Parameters:
#     METHOD: 'proximity', 'contact', or 'proximity_if_available'.
#             (Default: [beacon] home_method)
#     CALIBRATE: '1' or '0'. Forces/skips model creation.
#                (Default: [beacon] home_autocalibrate)
#
# BED_MESH_CALIBRATE [METHOD=<beacon|automatic>] [PROBE_METHOD=<...>]
#   Desc: Overrides BED_MESH_CALIBRATE to enable fast 'beacon' scanning.
#   Parameters:
#     METHOD: 'beacon' (default) runs the fast scan.
#             'automatic' runs Klipper's standard probe-by-point.
#     PROBE_METHOD: 'proximity' or 'contact'. (Default: [beacon] default_probe_method)
#
# --- Model Management Commands ---
#
# BEACON_MODEL_LIST
#   Desc: Lists all saved models in the console.
#
# BEACON_MODEL_SELECT NAME=<name>
#   Desc: Activates a previously saved model.
#   Parameters: NAME (required)
#
# BEACON_MODEL_SAVE [NAME=<name>]
#   Desc: Saves the currently active model. Can be renamed using NAME.
#   Parameters: NAME (optional)
#
# BEACON_MODEL_REMOVE NAME=<name>
#   Desc: Deletes a model from Klipper's config.
#   Parameters: NAME (required)
#
# --- Debugging Commands ---
#
# BEACON_QUERY
#   Desc: Takes a single proximity measurement and prints it to the console.
#
# BEACON_STREAM FILENAME=<path>
#   Desc: Streams all live data from the probe to a CSV file.
#   Parameters: FILENAME (required, e.g., /tmp/stream.csv)
#
# --------------------------------------------------------------------
